name: Fetch Steam Game Data

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
  push:
    paths:
      - 'AppID/**/achievements.json'

permissions:
  contents: write

jobs:
  fetch-data:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests beautifulsoup4 lxml

      - name: Fetch game data
        env:
          STEAM_API_KEY: ${{ secrets.STEAM_API_KEY }}
        run: |
          python - <<'EOF'
          import os
          import json
          import requests
          from pathlib import Path
          import time
          from bs4 import BeautifulSoup
          import re

          STEAM_API_KEY = os.environ.get('STEAM_API_KEY', '')

          # Find all AppID folders
          appid_dir = Path('AppID')
          if not appid_dir.exists():
              print("No AppID directory found")
              exit(0)

          appids = []
          for folder in appid_dir.iterdir():
              if folder.is_dir() and folder.name.isdigit():
                  achievements_file = folder / 'achievements.json'
                  if achievements_file.exists():
                      appids.append(folder.name)

          print(f"Found {len(appids)} games with achievements")

          all_game_data = []

          for appid in appids:
              print(f"\n{'='*60}")
              print(f"Processing AppID {appid}...")
              print(f"{'='*60}")
              
              game_info = {
                  'appid': appid,
                  'name': f'Game {appid}',
                  'icon': '',
                  'achievements': {}
              }

              try:
                  # Fetch from Steam Store API
                  print(f"[1/4] Fetching game info from Steam Store...")
                  store_url = f'https://store.steampowered.com/api/appdetails?appids={appid}'
                  store_response = requests.get(store_url, timeout=10)
                  
                  if store_response.ok:
                      store_data = store_response.json()
                      if appid in store_data and store_data[appid].get('success'):
                          data = store_data[appid]['data']
                          game_info['name'] = data.get('name', f'Game {appid}')
                          game_info['icon'] = data.get('header_image', '')
                          print(f"  ✓ Got game info: {game_info['name']}")
                  
                  time.sleep(1.5)

                  # Fetch achievement schema from Steam API
                  if STEAM_API_KEY:
                      print(f"[2/4] Fetching achievement schema from Steam API...")
                      schema_url = f'https://api.steampowered.com/ISteamUserStats/GetSchemaForGame/v2/?key={STEAM_API_KEY}&appid={appid}'
                      schema_response = requests.get(schema_url, timeout=10)
                      
                      if schema_response.ok:
                          schema_data = schema_response.json()
                          achievements = schema_data.get('game', {}).get('availableGameStats', {}).get('achievements', [])
                          
                          hidden_count = 0
                          for ach in achievements:
                              is_hidden = ach.get('hidden', 0) == 1
                              if is_hidden:
                                  hidden_count += 1
                              
                              game_info['achievements'][ach['name']] = {
                                  'name': ach.get('displayName', ach['name']),
                                  'description': ach.get('description', ''),
                                  'icon': ach.get('icon', ''),
                                  'icongray': ach.get('icongray', ''),
                                  'hidden': is_hidden
                              }
                          
                          print(f"  ✓ Got {len(achievements)} achievements ({hidden_count} hidden)")
                      
                      time.sleep(1.5)

                      # Fetch global achievement percentages
                      print(f"[3/4] Fetching achievement percentages...")
                      percent_url = f'https://api.steampowered.com/ISteamUserStats/GetGlobalAchievementPercentagesForApp/v0002/?gameid={appid}'
                      percent_response = requests.get(percent_url, timeout=10)
                      
                      if percent_response.ok:
                          percent_data = percent_response.json()
                          percentages = percent_data.get('achievementpercentages', {}).get('achievements', [])
                          
                          for ach_percent in percentages:
                              ach_name = ach_percent.get('name')
                              if ach_name in game_info['achievements']:
                                  game_info['achievements'][ach_name]['percent'] = ach_percent.get('percent', 0)
                          
                          print(f"  ✓ Got percentages for {len(percentages)} achievements")
                      
                      time.sleep(1.5)

                  # Find hidden achievements with empty descriptions
                  print(f"[4/4] Checking for hidden achievements needing descriptions...")
                  hidden_needing_desc = []
                  for api_name, ach_data in game_info['achievements'].items():
                      if ach_data['hidden'] and not ach_data['description']:
                          hidden_needing_desc.append(api_name)
                  
                  if hidden_needing_desc:
                      print(f"  → Found {len(hidden_needing_desc)} hidden achievements with empty descriptions")
                      print(f"  → Scraping SteamHunters for descriptions...")
                      
                      try:
                          hunters_url = f'https://steamhunters.com/apps/{appid}/achievements'
                          headers = {
                              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
                          }
                          
                          print(f"  → Requesting: {hunters_url}")
                          hunters_response = requests.get(hunters_url, headers=headers, timeout=20)
                          print(f"  → Status code: {hunters_response.status_code}")
                          
                          if hunters_response.ok:
                              soup = BeautifulSoup(hunters_response.content, 'html.parser')
                              
                              # Try multiple possible selectors
                              all_rows = []
                              
                              # Try common table structures
                              tables = soup.find_all('table')
                              print(f"  → Found {len(tables)} tables on page")
                              
                              for table in tables:
                                  rows = table.find_all('tr')
                                  all_rows.extend(rows)
                              
                              print(f"  → Found {len(all_rows)} total rows")
                              
                              # Also try div-based structures
                              achievement_divs = soup.find_all(['div', 'article'], class_=re.compile(r'achievement', re.I))
                              print(f"  → Found {len(achievement_divs)} achievement divs")
                              
                              updated_count = 0
                              
                              # Process rows
                              for row in all_rows:
                                  text = row.get_text()
                                  
                                  # Look for achievement names we need
                                  for api_name in hidden_needing_desc:
                                      ach_name = game_info['achievements'][api_name]['name']
                                      
                                      if ach_name.lower() in text.lower() or api_name.lower() in text.lower():
                                          # Try to find description
                                          desc_candidates = row.find_all(['td', 'div', 'p', 'span'])
                                          for candidate in desc_candidates:
                                              desc_text = candidate.get_text(strip=True)
                                              # Look for description-like text (not the title, has some length)
                                              if desc_text and desc_text != ach_name and len(desc_text) > 10 and len(desc_text) < 500:
                                                  game_info['achievements'][api_name]['description'] = desc_text
                                                  print(f"  ✓ Found description for '{ach_name}': {desc_text[:50]}...")
                                                  updated_count += 1
                                                  break
                              
                              if updated_count > 0:
                                  print(f"  ✓ Updated {updated_count} hidden achievement descriptions from SteamHunters")
                              else:
                                  print(f"  ⚠ Could not find descriptions on SteamHunters (page structure may have changed)")
                                  # Save a sample of the HTML for debugging
                                  print(f"  → Sample HTML structure:")
                                  print(soup.prettify()[:500])
                          else:
                              print(f"  ✗ SteamHunters returned status {hunters_response.status_code}")
                          
                          time.sleep(2)
                          
                      except Exception as e:
                          print(f"  ✗ Error scraping SteamHunters: {type(e).__name__}: {e}")
                  else:
                      print(f"  ✓ No hidden achievements need descriptions")

              except Exception as e:
                  print(f"  ✗ Error processing game: {type(e).__name__}: {e}")
                  import traceback
                  traceback.print_exc()

              # Save individual game-info.json
              game_info_path = Path(f'AppID/{appid}/game-info.json')
              with open(game_info_path, 'w', encoding='utf-8') as f:
                  json.dump(game_info, f, indent=2, ensure_ascii=False)

              # Load achievements.json to merge
              achievements_path = Path(f'AppID/{appid}/achievements.json')
              with open(achievements_path, 'r', encoding='utf-8') as f:
                  achievements_data = json.load(f)
              
              all_game_data.append({
                  'appid': appid,
                  'info': game_info,
                  'achievements': achievements_data
              })

          # Save combined game-data.json
          with open('game-data.json', 'w', encoding='utf-8') as f:
              json.dump(all_game_data, f, indent=2, ensure_ascii=False)

          print(f"\n{'='*60}")
          print(f"✓ Processed {len(appids)} games successfully")
          print(f"{'='*60}")
          EOF

      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add AppID/*/game-info.json game-data.json
          git diff --quiet && git diff --staged --quiet || git commit -m "Update game data from Steam"
          git push
